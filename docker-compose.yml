version: "3.8"

services:

###############################################################################
################################ PRODUCTION  ##################################
###############################################################################

################################# NETWORK #####################################

  # DNS-level ad + tracking blocker
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    network_mode: "host"
    restart: always
    cap_add:
      - NET_ADMIN
    dns:
      - 127.0.0.1
      - 1.1.1.1
    environment:
      - "TZ=${TZ}"
      - "WEBPASSWORD=${WEBPASSWORD}"
      - "DNS1=1.1.1.1"
      - "DNS2=1.0.0.1"
      - "DNSMASQ_LISTENING=all"
    volumes:
      - "${USERDIR}/docker/pihole/pihole/:/etc/pihole/"
      - "${USERDIR}/docker/pihole/dnsmasq.d/:/etc/dnsmasq.d"
      - "${USERDIR}/docker/pihole/pihole.log:/var/log/pihole.log"

  # VPN using wireguard protocol and Private Internet Access provider
  wireguard-pia:
    image: thrnz/docker-wireguard-pia:latest
    container_name: wireguard-pia
    restart: always
    depends_on:
      - pihole
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      # wg-quick fails to set this without --privileged, so set it here instead if needed
      - net.ipv4.conf.all.src_valid_mark=1
      # May as well disable ipv6. Should be blocked anyway.
      - net.ipv6.conf.default.disable_ipv6=1
      - net.ipv6.conf.all.disable_ipv6=1
      - net.ipv6.conf.lo.disable_ipv6=1
    # The container has no recovery logic. Use a healthcheck to catch disconnects.
    healthcheck:
      test: ping -c 1 www.google.com || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      - "LOC=${PIA_LOC}"
      - "USER=${PIA_USER}"
      - "PASS=${PIA_PASS}"
      - "LOCAL_NETWORK=${LOCAL_NET}"
    volumes:
      - "${USERDIR}/docker/wireguard-pia:/pia"
      - "${USERDIR}/docker/shared:/pia-shared"
    ports:
      - "${SERVER_IP}:9117:9117" # jackett
      - "${SERVER_IP}:9091:9091/tcp" # transmission
      - "${SERVER_IP}:51413:51413/tcp" # transmission
      - "${SERVER_IP}:51413:51413/udp" # transmission
      - "${SERVER_IP}:20202:8989/tcp" # sonarr
      - "${SERVER_IP}:5299:5299/tcp" # lazylibrarian
      - "${SERVER_IP}:30303:7878/tcp" # radarr
      - "${SERVER_IP}:3579:3579/tcp" # ombi

################################ MANAGEMENT ####################################

  # easy container and stack management + monitoring
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    network_mode: "host"
    restart: always
    environment:
      - "TZ=${TZ}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "${USERDIR}/docker/portainer:/data"
      - "${USERDIR}/docker/shared:/shared"

  # portal similar to commercial app locker (mobile-friendly!)
  heimdall:
    image: ghcr.io/linuxserver/heimdall:latest
    container_name: heimdall
    restart: unless-stopped
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
    volumes:
      - "${USERDIR}/docker/heimdall:/config"
    ports:
      - 303:80 # HTTP
      #- 720:443 # HTTPS -- unnecessary for now

################################# TORRENTS ####################################

  # torrent client -- currently has issues with magnet links in watch folder
  transmission:
    image: ghcr.io/linuxserver/transmission:latest
    container_name: transmission
    network_mode: "service:wireguard-pia"
    restart: unless-stopped
    depends_on:
      - wireguard-pia
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
      - "USER=${TRNS_USER}"
      - "PASS=${TRNS_PASS}"
      - TRANSMISSION_WEB_HOME=/transmission-web-control/ #optional
      - TRANSMISSION_WATCH_DIR_FORCE_GENERIC=true
    volumes:
      - "${USERDIR}/docker/transmission:/config"
      - "${STORAGE}/storage/transmission:/downloads"
      - "${USERDIR}/docker/shared/torrents:/watch"

  # torrent indexer -- can use [address]/torznab/all for full list
  jackett:
    image: ghcr.io/linuxserver/jackett:latest
    container_name: jackett
    network_mode: "service:wireguard-pia"
    restart: unless-stopped
    depends_on:
      - wireguard-pia
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
      - AUTO_UPDATE=true #optional
      #- RUN_OPTS=<run options here> #optional
    volumes:
      - "${USERDIR}/docker/jackett:/config"
      - "${USERDIR}/docker/shared/torrents:/downloads"

################################# MEDIA #######################################

  # media server for multiple devices -- considering swap to Jellyfin (on Roku!)
  plexms:
    image: plexinc/pms-docker:latest
    container_name: plexms
    network_mode: "host"
    restart: unless-stopped
    environment:
      - "TZ=${TZ}"
      - "PLEX_CLAIM=${PLEX_CLAIM}"
      - "PLEX_UID=${PUID}"
      - "PLEX_GID=${PGID}"
      - "ADVERTISE_IP=${PLEXENV}"
    volumes:
      - "${USERDIR}/docker/plexms:/config"
      - "${STORAGE}/plex_tmp:/transcode"
      - "${STORAGE}/tv_shows:/tv_shows"
      - "${STORAGE}/movies:/movies"
      - "${USERDIR}/docker/shared:/shared"

  # tv show media management, integrates with Jackett + Transmission + Plex
  sonarr:
    image: ghcr.io/linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: "service:wireguard-pia"
    restart: unless-stopped
    depends_on:
      - wireguard-pia
    restart: unless-stopped
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
    volumes:
      - "${USERDIR}/docker/sonarr:/config"
      - "${STORAGE}/tv_shows:/tv"
      - "${STORAGE}/storage/transmission:/downloads"

  # movie media management, integrates with Jackett + Transmission + Plex
  radarr:
    image: ghcr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: "service:wireguard-pia"
    restart: unless-stopped
    depends_on:
      - wireguard-pia
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
    volumes:
      - "${USERDIR}/docker/radarr:/config"
      - "${STORAGE}/movies:/movies"
      - "${STORAGE}/storage/transmission:/downloads"

  # ebook and audiobook manager/storefront -- extremely picky w/ metadata (ID3)
  lazylibrarian:
    image: ghcr.io/linuxserver/lazylibrarian
    container_name: lazylibrarian
    network_mode: "service:wireguard-pia"
    restart: unless-stopped
    depends_on:
      - pihole
      - wireguard-pia
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
      - DOCKER_MODS=linuxserver/calibre-web:calibre|linuxserver/mods:lazylibrarian-ffmpeg #optional
    volumes:
      - "${USERDIR}/docker/lazylibrarian:/config"
      - "${STORAGE}/storage/transmission/complete:/downloads"
      - "${STORAGE}/books/ebooks:/books"
      - "${STORAGE}/books/audiobooks:/audiobooks"
      - "${STORAGE}/books/import:/import"

############################### SMART HOME #####################################

  # home automation, monitoring, and functional dashboard creator
  homeassistant:
    image: homeassistant/home-assistant:stable
    container_name: home-assistant
    network_mode: "host"
    restart: unless-stopped
    environment:
      - "TZ=${TZ}"
      - "PUID=${PUID}"
      - "PGID=${PGID}"
    volumes:
      - "${USERDIR}/docker/homeassistant:/config"
      - /etc/localtime:/etc/localtime:ro

###############################################################################
############################## IN DEVELOPMENT #################################
###############################################################################

  # media request application for Sonarr, Radarr, Plex, etc...
  ombi:
    image: ghcr.io/linuxserver/ombi:latest
    container_name: ombi
    network_mode: "service:wireguard-pia"
    restart: unless-stopped
    depends_on:
      - pihole
      - wireguard-pia
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
      # for reverse proxy
      #- BASE_URL=/ombi #optional
    volumes:
      - "${USERDIR}/docker/ombi:/config"

  # pretty web interface for Calibre -- is this needed?
  calibre-web:
    image: ghcr.io/linuxserver/calibre-web:latest
    container_name: calibre-web
    restart: unless-stopped
    ports:
      - 8083:8083
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
      - DOCKER_MODS=linuxserver/calibre-web:calibre
    volumes:
      - "${USERDIR}/docker/shared/calibre:/config"
      - "${STORAGE}/books/ebooks:/books"

  # Guacamole running Calibre -- useful for ebooks, integrates w/ LazyLibrarian
  calibre:
    image: linuxserver/calibre:v4.23.0-ls78
    container_name: calibre
    restart: unless-stopped
    ports:
      - 8080:8080
      - 8081:8081
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
      - "GUAC_USER=${GUAC_USER}" #optional
      - "GUAC_PASS=${GUAC_PASS}" #optional
      #- CLI_ARGS= #optional
    volumes:
      - "${USERDIR}/docker/shared/calibre:/config"
      - "${STORAGE}/books/ebooks:/books"

  # working on getting a domain that actually redirects here...
  duckdns:
    image: ghcr.io/linuxserver/duckdns:latest
    container_name: duckdns
    restart: unless-stopped
    environment:
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "TZ=${TZ}"
      - "SUBDOMAINS=${DDNS_DOMAIN}"
      - "TOKEN=${DDNS_TOKEN}"
      - LOG_FILE=true #optional - needs /config if true
    volumes:
      - "${USERDIR}/docker/duckdns:/config"
